<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Content Manager</title>
    <link rel="icon" href="/assets/images/logo.png">
    <style>
      html, body { margin: 0; padding: 0; height: 100%; }
      #nc-root { display: flex; height: 100%; }
    </style>
  </head>
  <body>
    <div id="nc-root"></div>
    <script>
      // ===== SIMPLE DEBUG LOGGING =====
      const LOG = {
        info: (msg, data) => {
          const out = data ? `${msg} | ${JSON.stringify(data)}` : msg;
          console.log(`[Admin] ${out}`);
        },
        error: (msg, err) => console.error(`[Admin ERROR] ${msg}`, err),
        warn: (msg) => console.warn(`[Admin WARN] ${msg}`),
      };
      
      LOG.info('=== PAGE LOAD START ===');
      
      // ===== 1. CHECK URL TOKEN =====
      const url = new URL(window.location);
      const tokenFromUrl = url.searchParams.get('token');
      LOG.info('URL params', { has_token: !!tokenFromUrl, token_len: tokenFromUrl?.length || 0 });
      
      if (tokenFromUrl) {
        LOG.info('TOKEN FOUND IN URL - STORING');
        const storedUser = {
          token: tokenFromUrl,
          backend: 'github',
          backendName: 'github',
          login: 'github',
          isLoggedIn: true,
          timestamp: new Date().toISOString()
        };
        
        try {
          localStorage.setItem('netlify-cms-user', JSON.stringify(storedUser));
          LOG.info('STORED in localStorage', { keys: Object.keys(storedUser) });
        } catch (e) {
          LOG.error('Failed to store token', e);
        }
        
        // Clean URL
        window.history.replaceState({}, document.title, '/admin/');
        LOG.info('URL cleaned');
      }
      
      // ===== 2. CHECK EXISTING SESSION =====
      LOG.info('Checking existing localStorage');
      const existing = localStorage.getItem('netlify-cms-user');
      
      if (existing) {
        try {
          const user = JSON.parse(existing);
          LOG.info('SESSION FOUND', { 
            keys: Object.keys(user), 
            backend: user.backend || user.backendName,
            isLoggedIn: user.isLoggedIn,
            tokenLen: user.token?.length || 0
          });
        } catch (e) {
          LOG.error('Failed to parse session', e);
          localStorage.removeItem('netlify-cms-user');
        }
      } else {
        LOG.warn('NO SESSION FOUND in localStorage');
      }
      
      // ===== 3. LOAD DECAP CMS =====
      LOG.info('=== LOADING DECAP CMS ===');
      
      // Check session after Decap loads
      window.addEventListener('load', () => {
        LOG.info('WINDOW LOAD EVENT');
        setTimeout(() => {
          const session = localStorage.getItem('netlify-cms-user');
          LOG.info('Session after Decap load', { has_session: !!session });
        }, 500);
      });
      
    </script>
    <script src="https://unpkg.com/decap-cms@^3.9.0/dist/decap-cms.js"></script>
  </body>
</html>
