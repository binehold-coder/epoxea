<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Content Manager</title>
    <link rel="icon" href="/assets/images/logo.png">
    <style>
      html, body { margin: 0; padding: 0; height: 100%; }
      #nc-root { display: flex; height: 100%; }
    </style>
  </head>
  <body>
    <div id="nc-root"></div>
    <script>
      // ===== COMPREHENSIVE DEBUG LOGGING =====
      window.DEBUG_LOG = [];
      const LOG = {
        info: (msg, data) => {
          const out = data ? `${msg} | ${JSON.stringify(data)}` : msg;
          const full = `[Admin] ${out}`;
          console.log(full);
          window.DEBUG_LOG.push({ time: new Date().toISOString(), level: 'INFO', msg: full });
        },
        error: (msg, err) => {
          const full = `[Admin ERROR] ${msg}`;
          console.error(full, err);
          window.DEBUG_LOG.push({ time: new Date().toISOString(), level: 'ERROR', msg: full, err: String(err) });
        },
        warn: (msg) => {
          const full = `[Admin WARN] ${msg}`;
          console.warn(full);
          window.DEBUG_LOG.push({ time: new Date().toISOString(), level: 'WARN', msg: full });
        },
      };
      
      LOG.info('=== PAGE LOAD START ===');
      
      // ===== HOOK INTO window.open (OAuth popups) =====
      const origOpen = window.open;
      window.open = function(url, name, specs) {
        LOG.warn(`ðŸ”´ window.open called! URL: ${url.substring(0, 150)}`);
        LOG.warn(`Attempted OAuth because token in localStorage failed validation`);
        const stored = localStorage.getItem('netlify-cms-user');
        if (stored) {
          try {
            const user = JSON.parse(stored);
            LOG.warn(`Current token in storage:`, { tokenLen: user.token?.length, backend: user.backend });
          } catch (e) {
            LOG.error('Could not parse current session', e);
          }
        }
        return origOpen.call(window, url, name, specs);
      };
      
      // ===== HOOK INTO localStorage to see what Decap does =====
      const origSetItem = Storage.prototype.setItem;
      Storage.prototype.setItem = function(key, value) {
        if (key === 'netlify-cms-user') {
          try {
            const parsed = JSON.parse(value);
            LOG.info(`[STORAGE] setItem("netlify-cms-user", ...) with:`, { 
              tokenLen: parsed.token?.length, 
              keys: Object.keys(parsed) 
            });
          } catch (e) {
            LOG.info(`[STORAGE] setItem("netlify-cms-user", "${value.substring(0, 50)}...")`);
          }
        }
        return origSetItem.call(this, key, value);
      };
      
      const origGetItem = Storage.prototype.getItem;
      Storage.prototype.getItem = function(key) {
        const result = origGetItem.call(this, key);
        if (key === 'netlify-cms-user' && result) {
          try {
            const parsed = JSON.parse(result);
            LOG.info(`[STORAGE] getItem("netlify-cms-user") returned:`, { 
              tokenLen: parsed.token?.length, 
              keys: Object.keys(parsed),
              login: parsed.login 
            });
          } catch (e) {
            // ignore
          }
        }
        return result;
      };
      
      const origRemoveItem = Storage.prototype.removeItem;
      Storage.prototype.removeItem = function(key) {
        if (key === 'netlify-cms-user') {
          LOG.warn('ðŸ”´ [STORAGE] removeItem("netlify-cms-user") - SESSION CLEARED BY DECAP!');
          console.trace('[TRACE] removeItem called from:');
        }
        return origRemoveItem.call(this, key);
      };
      
      // ===== 1. CHECK URL TOKEN =====
      const url = new URL(window.location);
      const tokenFromUrl = url.searchParams.get('token');
      LOG.info('URL params', { has_token: !!tokenFromUrl, token_len: tokenFromUrl?.length || 0 });
      
      if (tokenFromUrl) {
        LOG.info('TOKEN FOUND IN URL - STORING');
        
        // Fetch user info to enrich session
        fetch(`https://api.github.com/user`, {
          headers: { 'Authorization': `token ${tokenFromUrl}` }
        })
        .then(r => r.json())
        .then(userInfo => {
          const storedUser = {
            token: tokenFromUrl,
            backend: 'github',
            backendName: 'github',
            login: userInfo.login || 'github',
            user: {
              login: userInfo.login,
              id: userInfo.id,
              avatar_url: userInfo.avatar_url,
              name: userInfo.name || userInfo.login
            },
            email: userInfo.email,
            isLoggedIn: true,
            timestamp: new Date().toISOString()
          };
          
          try {
            localStorage.setItem('netlify-cms-user', JSON.stringify(storedUser));
            LOG.info('STORED enriched session', { login: userInfo.login, keys: Object.keys(storedUser) });
          } catch (e) {
            LOG.error('Failed to store enriched token', e);
          }
        })
        .catch(e => {
          LOG.error('Failed to fetch user info', e);
          // Fall back to simple storage
          const storedUser = {
            token: tokenFromUrl,
            backend: 'github',
            backendName: 'github',
            login: 'github',
            isLoggedIn: true,
            timestamp: new Date().toISOString()
          };
          localStorage.setItem('netlify-cms-user', JSON.stringify(storedUser));
          LOG.info('STORED fallback session');
        });
        
        window.history.replaceState({}, document.title, '/admin/');
        LOG.info('URL cleaned');
      }
      
      // ===== 2. CHECK EXISTING SESSION =====
      LOG.info('Checking existing localStorage');
      const existing = localStorage.getItem('netlify-cms-user');
      
      if (existing) {
        try {
          const user = JSON.parse(existing);
          LOG.info('SESSION FOUND', { 
            keys: Object.keys(user), 
            backend: user.backend || user.backendName,
            isLoggedIn: user.isLoggedIn,
            tokenLen: user.token?.length || 0
          });
        } catch (e) {
          LOG.error('Failed to parse session', e);
          localStorage.removeItem('netlify-cms-user');
        }
      } else {
        LOG.warn('NO SESSION FOUND in localStorage');
      }
      
      // ===== 3. MONITOR STORAGE CHANGES =====
      window.addEventListener('storage', (e) => {
        if (e.key === 'netlify-cms-user') {
          LOG.warn(`STORAGE CHANGED: netlify-cms-user modified externally`);
        }
      });
      
      LOG.info('=== LOADING DECAP CMS ===');
      
      window.addEventListener('load', () => {
        LOG.info('WINDOW LOAD EVENT');
        const session = localStorage.getItem('netlify-cms-user');
        LOG.info('Session at window load', { has_session: !!session });
        
        // Print summary after 3 sec
        setTimeout(() => {
          LOG.info('=== DEBUG LOG EXPORT ===');
          console.log('Copy this to send logs: ');
          console.log(JSON.stringify(window.DEBUG_LOG, null, 2));
          LOG.info('Run: window.DEBUG_LOG to see all logs');
        }, 3000);
      });
      
    </script>
    <script src="https://unpkg.com/decap-cms@^3.9.0/dist/decap-cms.js"></script>
  </body>
</html>
